<div class="fixed inset-0 bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-50 overflow-y-auto px-4" style="top: 0; left: 0; right: 0; bottom: 5rem;">
<div class="w-full max-w-4xl mx-auto pt-4 pb-8">
  <!-- Header -->
  <div class="mb-6">
    <div class="flex items-center mb-4">
      <div class="flex items-center gap-3">
        <%= link_to dashboard_path, class: "bg-purple-100 hover:bg-purple-200 text-purple-700 border border-purple-300 font-semibold px-3 py-2 rounded-lg transition-colors min-h-[44px] min-w-[44px] inline-flex items-center justify-center", title: "Return to Dashboard" do %>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        <% end %>
        <div>
          <h1 class="text-3xl font-bold text-gray-900">Money Map</h1>
          <p class="text-gray-600 mt-1"><%= @month_name %></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Complete Budget Overview -->
  <% if @budget %>
    <div class="bg-gradient-to-br from-purple-100 to-indigo-100 rounded-xl p-4 sm:p-6 mb-6 shadow-sm border-2 border-purple-300">
      <h2 class="text-xl font-bold text-gray-900 mb-4 text-center">Budget Overview - <%= @month_name %></h2>
      
      <!-- Available Income (with carryover) -->
      <div class="mb-4 pb-4 border-b-2 border-purple-200">
        <p class="text-sm text-gray-600 mb-1">Available Income</p>
        <p class="text-2xl sm:text-3xl font-bold text-gray-900">
          <%= number_to_currency(@available_income) %>
          <% if @carryover != 0 %>
            <% if @carryover > 0 %>
              <span class="text-sm font-normal text-green-700 ml-2">(includes <%= number_to_currency(@carryover) %> from last month)</span>
            <% else %>
              <span class="text-sm font-normal text-red-700 ml-2">(includes <%= number_to_currency(@carryover.abs) %> debt from last month)</span>
            <% end %>
          <% end %>
        </p>
      </div>

      <!-- Income Summary -->
      <div class="mb-4 pb-4 border-b border-purple-200">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Income Summary</h3>
        <div class="grid grid-cols-3 gap-2 sm:gap-4">
          <div class="text-center sm:text-left">
            <p class="text-xs sm:text-sm text-gray-600 mb-1">Expected</p>
            <p class="text-lg sm:text-2xl font-bold text-gray-900"><%= number_to_currency(@expected_income) %></p>
          </div>
          <div class="text-center sm:text-left">
            <p class="text-xs sm:text-sm text-gray-600 mb-1">Received</p>
            <p class="text-lg sm:text-2xl font-bold text-gray-900"><%= number_to_currency(@total_income) %></p>
          </div>
          <div class="text-center sm:text-left">
            <p class="text-xs sm:text-sm text-gray-600 mb-1">Still Coming</p>
            <p class="text-lg sm:text-2xl font-bold <%= (@expected_income - @total_income) > 0 ? 'text-orange-600' : 'text-green-600' %>">
              <%= number_to_currency(@expected_income - @total_income) %>
            </p>
          </div>
        </div>
      </div>

      <!-- Spending Summary -->
      <div class="mb-4 pb-4 border-b border-purple-200">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Spending Summary</h3>
        <div class="grid grid-cols-3 gap-2 sm:gap-4">
          <div class="text-center sm:text-left">
            <p class="text-xs sm:text-sm text-gray-600 mb-1">Allotted</p>
            <p class="text-lg sm:text-2xl font-bold text-gray-900"><%= number_to_currency(@total_allotted) %></p>
          </div>
          <div class="text-center sm:text-left">
            <p class="text-xs sm:text-sm text-gray-600 mb-1">Spent</p>
            <p class="text-lg sm:text-2xl font-bold text-gray-900"><%= number_to_currency(@total_spent) %></p>
          </div>
          <div class="text-center sm:text-left">
            <p class="text-xs sm:text-sm text-gray-600 mb-1">Remaining</p>
            <p class="text-lg sm:text-2xl font-bold <%= @remaining >= 0 ? 'text-green-600' : 'text-red-600' %>">
              <%= number_to_currency(@remaining) %>
            </p>
          </div>
        </div>
      </div>

      <!-- Budget Health -->
      <div>
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Budget Health</h3>
        <div class="grid grid-cols-2 gap-2 sm:gap-4">
          <div class="text-center sm:text-left">
            <p class="text-xs sm:text-sm text-gray-600 mb-1">Available to Assign</p>
            <p class="text-lg sm:text-2xl font-bold <%= @remaining_to_assign >= 0 ? 'text-green-600' : 'text-orange-600' %>">
              <%= number_to_currency(@remaining_to_assign) %>
            </p>
          </div>
          <div class="text-center sm:text-left">
            <p class="text-xs sm:text-sm text-gray-600 mb-1">Status</p>
            <p class="text-lg sm:text-2xl font-bold <%= @remaining >= 0 && @remaining_to_assign >= 0 ? 'text-green-600' : 'text-orange-600' %>">
              <%= @remaining >= 0 && @remaining_to_assign >= 0 ? '✅ On Track' : '⚠️ Review Needed' %>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Money In Section -->
    <div class="mb-6" data-controller="expand" data-expand-type-value="income">
      <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
        <h2 class="text-2xl font-bold text-gray-900">Money In</h2>
        <div class="flex items-center gap-2 flex-wrap">
          <%= link_to "Add Custom Income", new_income_event_path(return_to: 'money_map'), 
                class: "px-3 py-2 text-sm text-green-600 hover:text-green-700 hover:bg-green-50 font-medium rounded-lg transition-colors min-h-[44px] inline-flex items-center justify-center" %>
          <%= link_to "Manage Sources", income_templates_path(return_to: 'money_map'),
                class: "px-3 py-2 text-sm text-green-600 hover:text-green-700 hover:bg-green-50 font-medium rounded-lg transition-colors min-h-[44px] inline-flex items-center justify-center" %>
          <% if @income_events.count > 5 %>
            <button type="button" 
                    data-expand-target="toggle"
                    data-action="click->expand#toggle"
                    class="px-3 py-2 text-sm text-green-600 hover:text-green-700 hover:bg-green-50 font-medium rounded-lg transition-colors min-h-[44px] min-w-[44px] inline-flex items-center justify-center">
              View All Sources
            </button>
          <% end %>
        </div>
      </div>
      <% if @income_events.any? %>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
          <div class="space-y-3">
            <% @income_events.each_with_index do |event, index| %>
              <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-0 <%= 'hidden' if index >= 5 %>" 
                   data-expand-target="item"
                   data-expand-index="<%= index %>">
                <div class="flex-1">
                  <p class="font-medium text-gray-900"><%= event.display_name %></p>
                  <p class="text-sm text-gray-500"><%= event.received_on.strftime("%B %d") %></p>
                </div>
                <div class="text-right">
                  <p class="font-semibold <%= event.actual_amount > 0 ? 'text-gray-900' : 'text-gray-400' %>">
                    <%= number_to_currency(event.actual_amount) %>
                  </p>
                  <% if event.actual_amount == 0 && event.income_template %>
                    <p class="text-xs text-gray-400">Expected: <%= number_to_currency(event.income_template.estimated_amount) %></p>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% else %>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 text-center">
          <p class="text-gray-500">No income events yet this month.</p>
        </div>
      <% end %>
    </div>

    <!-- Spending Section -->
    <div class="mb-6" data-controller="expand" data-expand-type-value="expense">
      <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
        <h2 class="text-2xl font-bold text-gray-900">Spending</h2>
        <div class="flex items-center gap-2 flex-wrap">
          <%= link_to "Add Custom Expense", new_expense_path(return_to: 'money_map'), 
                class: "px-3 py-2 text-sm text-amber-600 hover:text-amber-700 hover:bg-amber-50 font-medium rounded-lg transition-colors min-h-[44px] inline-flex items-center justify-center" %>
          <%= link_to "Manage Spending", expense_templates_path(return_to: 'money_map'),
                class: "px-3 py-2 text-sm text-amber-600 hover:text-amber-700 hover:bg-amber-50 font-medium rounded-lg transition-colors min-h-[44px] inline-flex items-center justify-center" %>
          <% if @expenses.count > 5 %>
            <button type="button" 
                    data-expand-target="toggle"
                    data-action="click->expand#toggle"
                    class="px-3 py-2 text-sm text-amber-600 hover:text-amber-700 hover:bg-amber-50 font-medium rounded-lg transition-colors min-h-[44px] min-w-[44px] inline-flex items-center justify-center">
              View All Spending
            </button>
          <% end %>
        </div>
      </div>
      <% if @expenses.any? %>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
          <div class="space-y-3">
            <% @expenses.each_with_index do |expense, index| %>
              <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-0 <%= 'hidden' if index >= 5 %>" 
                   data-expand-target="item"
                   data-expand-index="<%= index %>">
                <div class="flex-1">
                  <p class="font-medium text-gray-900"><%= expense.display_name %></p>
                  <p class="text-sm text-gray-500">
                    <%= number_to_currency(expense.spent_amount) %> of <%= number_to_currency(expense.allotted_amount) %>
                  </p>
                </div>
                <div class="text-right">
                  <p class="font-semibold <%= expense.remaining >= 0 ? 'text-green-600' : 'text-red-600' %>">
                    <%= number_to_currency(expense.remaining.abs) %> <%= expense.remaining >= 0 ? 'left' : 'over' %>
                  </p>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% else %>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 text-center">
          <p class="text-gray-500">No expenses yet this month.</p>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
</div>

