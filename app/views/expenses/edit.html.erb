<div class="max-w-2xl mx-auto py-8 px-4" 
     data-controller="swipe-back" 
     data-swipe-back-back-url-value="<%= case @return_to
                                          when 'money_map'
                                            money_map_path(scroll_to: 'spending-section')
                                          else
                                            expenses_path(month: @viewing_month)
                                          end %>"
     data-action="touchstart->swipe-back#touchStart touchmove->swipe-back#touchMove touchend->swipe-back#touchEnd">
  <% back_path = case @return_to
                 when 'money_map'
                   money_map_path(scroll_to: 'spending-section')
                 else
                   expenses_path(month: @viewing_month)
                 end %>

  <div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">Manage <%= @expense.display_name %></h1>
  </div>

  <%# Payment Summary Section - First %>
  <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl shadow-sm border-2 border-amber-200 p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <div class="bg-amber-100 rounded-lg p-2">
          <svg class="w-6 h-6 text-amber-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
        </div>
        <div>
          <h2 class="text-xl font-semibold text-gray-900">Payment History</h2>
          <p class="text-sm text-gray-600">Manage payment history for this expense</p>
        </div>
      </div>
      <%= link_to back_path, 
            class: "text-gray-600 hover:text-gray-900 font-medium text-sm px-4 py-2 min-h-[44px] inline-flex items-center justify-center rounded-lg transition-colors" do %>
        Done
      <% end %>
    </div>
    
    <% allotted = @expense.allotted_amount || 0 %>
    <% spent = @expense.spent_amount %>
    <% remaining = [allotted - spent, 0].max %>
    <% percent_spent = allotted > 0 ? [(spent / allotted * 100).round(1), 100].min : 0 %>
    
    <div class="bg-white rounded-lg p-4 mb-6 border border-amber-200">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center mb-4">
          <div>
            <p class="text-sm text-gray-600">Allotted</p>
            <p class="text-lg font-semibold text-gray-900"><%= number_to_currency(allotted) %></p>
          </div>
          <div>
            <p class="text-sm text-gray-600">Spent</p>
            <p class="text-lg font-semibold <%= spent > allotted ? 'text-red-600' : 'text-gray-900' %>"><%= number_to_currency(spent) %></p>
          </div>
          <div>
            <p class="text-sm text-gray-600">Remaining</p>
            <p class="text-lg font-semibold <%= remaining == 0 ? 'text-gray-500' : 'text-green-600' %>"><%= number_to_currency(remaining) %></p>
          </div>
        </div>
        
        <%# Progress Bar %>
        <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
          <div class="h-3 rounded-full <%= spent > allotted ? 'bg-red-500' : 'bg-blue-500' %>" 
               style="width: <%= [percent_spent, 100].min %>%"></div>
        </div>
        <p class="text-xs text-gray-500 text-center"><%= percent_spent %>% spent</p>
      </div>

    <%# Existing Payments List with Edit Capability %>
    <% if @expense.payments.any? %>
      <div class="bg-white border border-amber-200 rounded-lg p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4">Payment History</h3>
          <div class="space-y-3">
            <% @expense.payments.order(spent_on: :desc, created_at: :desc).each do |payment| %>
              <details class="group">
                <summary class="flex items-center justify-between p-4 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors list-none min-h-[44px]">
                  <div class="flex-1">
                    <div class="flex items-center gap-3 flex-wrap">
                      <p class="font-semibold text-gray-900"><%= number_to_currency(payment.amount) %></p>
                      <p class="text-sm text-gray-600"><%= payment.spent_on.strftime("%b %d, %Y") %></p>
                      <% if payment.notes.present? %>
                        <p class="text-sm text-gray-500">â€¢ <%= payment.notes %></p>
                      <% end %>
                    </div>
                  </div>
                  <div class="flex items-center gap-2 flex-shrink-0">
                    <span class="text-xs text-gray-500 group-open:hidden">Edit</span>
                    <svg class="w-4 h-4 text-gray-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                  </div>
                </summary>
                <div class="mt-3 p-4 bg-white border border-gray-200 rounded-lg">
                  <%= form_with model: payment, url: payment_path(payment), method: :patch, class: "space-y-4", data: { turbo: true } do |pf| %>
                    <%= hidden_field_tag :return_to, @return_to if @return_to.present? %>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div>
                        <%= pf.label :amount, "Amount", class: "block text-sm font-medium text-gray-700 mb-2" %>
                        <div class="relative">
                          <span class="absolute left-3 top-2 text-gray-500">$</span>
                          <%= pf.number_field :amount, 
                                step: "0.01", 
                                min: "0.01",
                                class: "w-full px-4 py-3 pl-8 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base",
                                required: true %>
                        </div>
                      </div>
                      
                      <div>
                        <%= pf.label :spent_on, "Date", class: "block text-sm font-medium text-gray-700 mb-2" %>
                        <%= pf.date_field :spent_on, 
                              class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base",
                              required: true %>
                      </div>
                    </div>
                    
                    <div>
                      <%= pf.label :notes, "Notes (optional)", class: "block text-sm font-medium text-gray-700 mb-2" %>
                      <%= pf.text_field :notes, 
                            placeholder: "e.g., Groceries, Gas, etc.",
                            class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base" %>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-3 pt-2">
                      <%= pf.submit "Update Payment", 
                            class: "bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors cursor-pointer min-h-[44px] text-base flex-1" %>
                      <button type="button" onclick="this.closest('details').removeAttribute('open')" 
                              class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold px-6 py-3 rounded-lg transition-colors min-h-[44px] text-base flex-1">
                        Cancel
                      </button>
                    </div>
                  <% end %>
                  
                  <%# Separate delete form outside the update form %>
                  <div class="mt-2 pt-2 border-t border-gray-200" 
                       data-controller="payment-delete"
                       data-payment-delete-payment-amount-value="<%= number_to_currency(payment.amount) %>">
                    <%= form_with url: payment_path(payment), method: :delete, class: "inline", 
                          data: { 
                            turbo: true,
                            payment_delete_target: "form"
                          } do |df| %>
                      <%= hidden_field_tag :return_to, @return_to if @return_to.present? %>
                      <%= df.submit "Delete Payment", 
                            class: "w-full bg-red-600 hover:bg-red-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors cursor-pointer min-h-[44px] text-base" %>
                    <% end %>
                  </div>
                </div>
              </details>
            <% end %>
          </div>
          <div class="mt-4 pt-4 border-t border-gray-200">
            <p class="text-sm text-gray-600">
              <span class="font-semibold">Total:</span> 
              <%= number_to_currency(@expense.payments.sum(:amount)) %> 
              across <%= pluralize(@expense.payments.count, 'payment') %>
            </p>
          </div>
      </div>
    <% else %>
      <div class="bg-white rounded-lg p-6 text-center border border-amber-200">
        <p class="text-gray-500">No payments recorded yet. <%= link_to "Add a payment", expense_path(@expense, return_to: @return_to), class: "text-blue-600 hover:text-blue-800 underline" %> to get started.</p>
      </div>
    <% end %>
  </div>

  <%# Expense Edit Section - Second %>
  <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl shadow-sm border-2 border-blue-200 p-6">
    <div class="flex items-center gap-3 mb-4">
      <div class="bg-blue-100 rounded-lg p-2">
        <svg class="w-6 h-6 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
        </svg>
      </div>
      <div>
        <h2 class="text-xl font-semibold text-gray-900"><%= @expense.display_name %> Details</h2>
        <p class="text-sm text-gray-600">Edit name and budgeted amount</p>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-blue-200 p-6">
      <%= form_with model: @expense, url: expense_path(@expense), method: :patch, class: "space-y-6" do |f| %>
        <%= hidden_field_tag :month, @viewing_month if @viewing_month %>
        <%= hidden_field_tag :return_to, @return_to if @return_to.present? %>
        <% if @expense.errors.any? %>
          <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <h3 class="text-red-800 font-semibold mb-2">
              <%= pluralize(@expense.errors.count, "error") %> prevented this expense from being saved:
            </h3>
            <ul class="list-disc list-inside text-red-700 space-y-1">
              <% @expense.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <div>
          <%= f.label :name, "Expense Name", class: "block text-sm font-medium text-gray-700 mb-2" do %>
            Expense Name <span class="text-red-500">*</span>
          <% end %>
          <%= f.text_field :name, 
                value: @expense.read_attribute(:name),
                placeholder: "Enter name of expense",
                required: true,
                class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base" %>
          <p class="mt-1 text-sm text-gray-500">The name of this expense. You can customize it even if it was created from a template.</p>
        </div>

        <div>
          <%= f.label :allotted_amount, "Allotted Amount", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <div class="relative">
            <span class="absolute left-3 top-2 text-gray-500">$</span>
            <%= f.number_field :allotted_amount, 
                  step: "0.01", 
                  min: "0",
                  placeholder: "0.00",
                  class: "w-full px-4 py-3 pl-8 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base" %>
          </div>
          <p class="mt-1 text-sm text-gray-500">Adjust the budgeted amount for this expense. This only affects the current month.</p>
        </div>

        <div class="flex flex-col sm:flex-row gap-4 pt-4">
          <%= f.submit "Update Expense", 
                class: "bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors cursor-pointer min-h-[44px] text-base flex-1" %>
          <%= link_to "Cancel", back_path, 
                class: "bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold px-6 py-3 rounded-lg transition-colors min-h-[44px] text-base flex-1 text-center" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

